def slackNotify(String message){
	def notify_head = "*Jenkins job:* ${env.JOB_NAME}, *Build:* #${env.BUILD_NUMBER}\n"
	def notify_message = notify_head + message
        slackSend(channel: '#itacademy-notifications', message: notify_message)
}

def deployToEnv(String envName, String image, String addMessageInfo) {
	stage("Deploy to ${envName}") {
		def message="Confirmation of image ${image} deployment for environment ${envName} is required.\nIf confirmation is not received within 30 minutes, the deployment will be rejected\n"
		message+=addMessageInfo

		slackNotify(message)
		
		timeout(time: 30, unit: 'MINUTES') {
		        input message: message, ok: 'Deploy'
		        submitter: 'admin'      
		}

		echo "Deploying ${image} to ${envName}"
	}
        stage("Test after deployment to ${envName}") {
                echo "Test"
        }

	return success
}

pipeline {
    agent { label 'docker && k8s' }
    stages {
        stage('Clone repository') {
            steps {
              dir('repo') {
                git url: 'https://github.com/romastelchenko/it-academy.21-jenkins-docker-and-pod.git', branch: 'main'
              }
	    }
        }
        stage('Checking repository'){
            steps {
                sh "ls -l"
            }
        }
        stage('Validate Dockerfile') {
            steps {
                sh """
		echo "Validate Dockerfile"
                """
            }
        }
        stage('Build image') {
            steps {
                sh """
                echo "Build image"
                """
            }
        }
        stage('Run and test image') {
            steps {
                sh """
                echo "Run and test image"
                """
            }
        }

        stage('Push image to the registry') {
            steps {
                sh """
                echo "Push image to the registry"
                """
            }
        }

	stage('Deploys') {
	    steps {
               def preProdStatus = deployToEnv('pre-prod',   "2")
	       if (preProdStatus == 'success' ) {
                    deployToEnv('prod', "image")
               }
	       removeDeploy('pre-prod', "image")
            }
        }

    }
    post {
        always {
          script {
            def status_emoji = [
              'SUCCESS' : ':large_green_circle:',
              'FAILURE' : ':red_circle:'
            ]
            def status = currentBuild.currentResult ?: 'UNKNOWN'
            def emoji  = status_emoji.get(status, ':large_yellow_circle:')
            def notify_message = "*Status:* ${emoji} ${status}"
	    slackNotify(notify_message)
          }
        }
    }
}
